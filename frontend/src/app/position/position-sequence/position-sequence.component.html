<div class="positions-container">
  <div class="selected-positions-container" #selectedPositionsContainer>
    <div class="selected-positions">
      <app-section-header
        title="Reihenfolge Positionen"
        [showDelete]="false"
        [showAdd]="enableEdit()"
        (add)="openPositionSelector()">
      </app-section-header>

      <div class="positions-grid" 
           cdkDropList 
           [cdkDropListDisabled]="!enableEdit()"
           (cdkDropListDropped)="onDrop($event)">
        <div *ngFor="let position of selectedPositions; let i = index" 
             class="position-card"
             cdkDrag
             [cdkDragDisabled]="!enableEdit()"
             [cdkDragData]="position">
          <div class="position-header">
            <button mat-icon-button 
                    class="check-circle" 
                    [disabled]="!enableEdit()"
                    (click)="toggleSelection(position)">
              <mat-icon class="check-circle-icon" [ngClass]="{ 'selected': position.isSelected }">
                {{ position.isSelected ? 'check_circle' : 'radio_button_unchecked' }}
              </mat-icon>
            </button>
            <span class="position-number">{{ position.number }}</span>
            <span class="position-name">{{ position.name }}</span>
            <button *ngIf="enableEdit()"
                    class="button button-label button-highlight-sub" 
                    (click)="onRemovePosition(position)">
              <mat-icon>remove</mat-icon>
              <span>Entfernen</span>
            </button>
            <div class="drag-handle" *ngIf="enableEdit()" cdkDragHandle>
              <mat-icon>drag_handle</mat-icon>
            </div>
          </div>
          <div class="position-details">
            <div class="metric-column" *ngIf="position.timePreset !== undefined">
              <mat-icon [class.disabled]="position.timePreset === 0">timer</mat-icon>
              <span class="label" [class.disabled]="position.timePreset === 0">Zeit</span>
              <span class="value" 
                    tabindex="0"
                    role="button"
                    (click)="enableEdit() && startEditing(position, 'timePreset')"
                    (keydown.enter)="enableEdit() && startEditing(position, 'timePreset')"
                    (keydown.space)="enableEdit() && startEditing(position, 'timePreset')"
                    *ngIf="!isEditing(position, 'timePreset')">
                {{ position.timePreset | number:'1.2-2' }}<span class="unit" [class.disabled]="position.timePreset === 0">Min</span>
              </span>
              <input #valueInput
                     class="value-input" 
                     *ngIf="isEditing(position, 'timePreset')"
                     [value]="formatNumber(position.timePreset)"
                     (keydown)="validateInput($event)"
                     (keydown.enter)="confirmEdit(position, 'timePreset', valueInput.value)"
                     (keydown.escape)="cancelEdit()"
                     (blur)="confirmEdit(position, 'timePreset', valueInput.value)"
                     (paste)="$event.preventDefault()"
                     type="text"
                     inputmode="decimal">
            </div>
            <div class="metric-column" [class.disabled]="!hasCurrentCapability(position)">
              <mat-icon [class.disabled]="position.currentPreset === 0">bolt</mat-icon>
              <span class="label" [class.disabled]="position.currentPreset === 0">Strom</span>
              <span class="value" 
                    tabindex="0"
                    role="button"
                    (click)="enableEdit() && hasCurrentCapability(position) && startEditing(position, 'currentPreset')"
                    (keydown.enter)="enableEdit() && hasCurrentCapability(position) && startEditing(position, 'currentPreset')"
                    (keydown.space)="enableEdit() && hasCurrentCapability(position) && startEditing(position, 'currentPreset')"
                    *ngIf="!isEditing(position, 'currentPreset') && hasCurrentCapability(position)">
                {{ position.currentPreset | number:'1.2-2' }}<span class="unit" [class.disabled]="!hasCurrentCapability(position)">A</span>
              </span>
              <input #valueInput
                     class="value-input" 
                     *ngIf="isEditing(position, 'currentPreset') && hasCurrentCapability(position)"
                     [value]="formatNumber(position.currentPreset)"
                     [disabled]="!hasCurrentCapability(position)"
                     (keydown)="validateInput($event)"
                     (keydown.enter)="confirmEdit(position, 'currentPreset', valueInput.value)"
                     (keydown.escape)="cancelEdit()"
                     (blur)="confirmEdit(position, 'currentPreset', valueInput.value)"
                     (paste)="$event.preventDefault()"
                     type="text"
                     inputmode="decimal">
            </div>
            <div class="metric-column" [class.disabled]="!hasVoltageCapability(position)">
              <mat-icon [class.disabled]="position.voltagePreset === 0" class="mat-icon-filled">bolt</mat-icon>
              <span class="label" [class.disabled]="position.voltagePreset === 0">Spannung</span>
              <span class="value" 
                    tabindex="0"
                    role="button"
                    (click)="enableEdit() && hasVoltageCapability(position) && startEditing(position, 'voltagePreset')"
                    (keydown.enter)="enableEdit() && hasVoltageCapability(position) && startEditing(position, 'voltagePreset')"
                    (keydown.space)="enableEdit() && hasVoltageCapability(position) && startEditing(position, 'voltagePreset')"
                    *ngIf="!isEditing(position, 'voltagePreset') && hasVoltageCapability(position)">
                {{ position.voltagePreset | number:'1.2-2' }}<span class="unit" [class.disabled]="!hasVoltageCapability(position)">V</span>
              </span>
              <input #valueInput
                     class="value-input" 
                     *ngIf="isEditing(position, 'voltagePreset') && hasVoltageCapability(position)"
                     [value]="formatNumber(position.voltagePreset)"
                     [disabled]="!hasVoltageCapability(position)"
                     (keydown)="validateInput($event)"
                     (keydown.enter)="confirmEdit(position, 'voltagePreset', valueInput.value)"
                     (keydown.escape)="cancelEdit()"
                     (blur)="confirmEdit(position, 'voltagePreset', valueInput.value)"
                     (paste)="$event.preventDefault()"
                     type="text"
                     inputmode="decimal">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <app-sidebar-sheet 
    title="Verfügbare Positionen"
    [(show)]="showPositionSelector"
    (showChange)="showPositionSelector = $event">
    
    <div class="available-positions">
      <div class="positions-grid">
        <div *ngFor="let position of positionService.orderedPositions()" class="position-card">
          <div class="position-header">
            <span class="position-name" [attr.data-number]="position.number">{{ position.name }}</span>
            <button class="button button-label button-highlight-main" (click)="onAddPosition(position, $event)">
              <mat-icon>add</mat-icon>
              <span>Hinzufügen</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </app-sidebar-sheet>
</div>
